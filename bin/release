#!/usr/bin/env bash

set -euo pipefail

BUILD_DIR="${1}"

echo "---"

dependencies_file_path="${BUILD_DIR}/.heroku/sbt-dependency-classpath.log"

# Auto-provision Heroku Postgres if PostgreSQL dependencies are detected.
# Only applicable to accounts created before May 15, 2023 or accounts with auto-provisioning enabled.
# See: https://devcenter.heroku.com/articles/scala-support#postgres-auto-provisioning
if [[ -f "${dependencies_file_path}" ]]; then
	postgresql_dependencies=(
		"com/impossibl/pgjdbc-ng" # https://impossibl.github.io/pgjdbc-ng/
		"org/postgresql"          # https://jdbc.postgresql.org/
		"skunk-core"              # https://typelevel.org/skunk/
		"postgresql-async"        # https://github.com/postgresql-async/postgresql-async
		"quill-ndbc-postgres"     # https://github.com/zio/zio-quill
	)

	for dependency in "${postgresql_dependencies[@]}"; do
		if grep -q "${dependency}" "${dependencies_file_path}"; then
			echo "addons:"
			echo "  - heroku-postgresql"
			break
		fi
	done
fi

if [[ ! -f "${BUILD_DIR}/Procfile" ]]; then
	# Use sbt-native-packager executable if exactly one is found.
	# https://www.scala-sbt.org/sbt-native-packager/archetypes/java_app/index.html
	# Search for executables in both single-project (target/universal/stage/bin) and
	# multi-project (*/target/universal/stage/bin) locations.
	mapfile -t -d '' sbt_native_packager_executables < <(find "${BUILD_DIR}" -path "*/target/universal/stage/bin/*" -type f -executable -print0 2>/dev/null)
	if [[ "${#sbt_native_packager_executables[@]}" -eq 1 ]]; then
		# Include -Dhttp.port=$PORT since many sbt-native-packager apps use Play Framework.
		# Apps that don't use the http.port system property will not be negatively affected by setting it.
		echo "default_process_types:"
		echo "  web: ${sbt_native_packager_executables[0]#"${BUILD_DIR}/"} -Dhttp.port=\$PORT"
	elif [[ -f "${BUILD_DIR}/target/start" ]]; then
		# Legacy support for Play Framework < 2.4.0 (released April 2015).
		# Kept due to low maintenance cost and usefulness for legacy apps without a Procfile.
		# Play 2.4.0+ uses sbt-native-packager exclusively.
		# Note: $JAVA_OPTS included for backwards compatibility with deployments that historically relied on it.
		echo "default_process_types:"
		echo "  web: target/start -Dhttp.port=\$PORT \$JAVA_OPTS"
	fi
fi
